# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

name: ci

on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main", "dev"]

jobs:
  linux:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        test-gpu: ["false"] # add GPU testing when available
    defaults:
      run:
        shell: bash -l {0}
    name: Linux py ${{ matrix.python-version }} tests ${{ matrix.test-gpu }}

    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.x"
      - name: Set up Miniconda (${{ matrix.python-version }})
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ matrix.python-version }}
          activate-environment: protpardelle
          channels: conda-forge,bioconda,defaults
          use-mamba: true
      - name: Set environment
        run: |
          bash setup.sh --dev
      - name: Verify GPU setup
        if: matrix.test-gpu == true
        run: |
          python -c "
          import torch
          print(f'PyTorch CUDA available: {torch.cuda.is_available()}')
          if torch.cuda.is_available():
              print(f'CUDA devices: {torch.cuda.device_count()}')
              print(f'Device name: {torch.cuda.get_device_name(0)}')
          "

      - name: Check style
        run: |
          pre-commit run
      - name: Run tests (parallel with coverage)
        run: |
          pytest -n auto --dist=loadscope \
            --cov=protpardelle --cov-report=xml --cov-report=html \
            tests/
      - name: Upload code coverage report
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-html
          path: htmlcov
      - name: Create code coverage markdown report
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          reportgenerator -reports:coverage.xml -targetdir:coveragereport -reporttypes:'MarkdownSummaryGithub'
      - name: Write to job summary
        run: cat coveragereport/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

      - name: Add comment to PR # Only applicable if 'MarkdownSummaryGithub' or one of the other Markdown report types is generated
        if: github.event_name == 'pull_request'
        run: gh pr comment $PR_NUMBER --body-file coveragereport/SummaryGithub.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        continue-on-error: true # workflow triggered by PRs from external forks cannot comment
